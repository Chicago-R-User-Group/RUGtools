---
title: "New Meetup Members"
author: "Justin M. Shea"
date: "April 9, 2018"
output: html_vignette
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{New Meetup Members}
  %\usepackage[UTF-8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Import 
 
This assumes manual download of the meetup member list file to the `inst/extdata` folder of your working directory and saved it as `.csv`, not the default `.xls`.

```{r}
library(knitr)

member_file_path <- system.file("extdata", "ChicagoRUG_Member_List_on_04-09-18.csv", package = "CRUGtools", mustWork = TRUE)

member_list <- read.csv(member_file_path, stringsAsFactors=FALSE)
```


## Data Clean and Format 


First, convert dates of charachter type to `Date`.

```{r}
member_list$Joined.Group.on <- as.Date.character(member_list$Joined.Group.on, format = "%m/%d/%Y")
member_list$Last.visited.group.on <- as.Date.character(member_list$Last.visited.group.on, format = "%m/%d/%Y")
member_list$Last.Attended <- as.Date.character(member_list$Last.Attended, format = "%m/%d/%Y")
```

Next, convert binary responses into factors

```{r}
member_list$Intro <- as.factor(member_list$Intro)
member_list$Photo <- as.factor(member_list$Photo)
member_list$Assistant.Organizer <- as.factor(member_list$Assistant.Organizer) 
member_list$Mailing.List <- as.factor(member_list$Mailing.List)
```

  
## Question: How many joined since January of 2017?  
 
 
First, sort member list by "Joined.Group.on" variable

```{r}
member_list <- member_list[order(member_list$Joined.Group.on),]
```

Next, add cumalitive sum aka "count_index"

```{r}
member_list$count_index <- seq(from =1, to = NROW(member_list), by = 1)
```

Lets plot it!

```{r}
plot(y = member_list$count_index, x = member_list$Joined.Group.on, type = "l", col = "blue",
     main = "Cumulative CRUG members",  
         ylab = "Members", xlab = "")
```

How many members since January 2017?

```{r}
members_2017_present <- subset(member_list, Joined.Group.on > "2017-01-01")

max(members_2017_present$count_index) - min(members_2017_present$count_index)

```


# Question: How many joined since the last meetup? 

First, get a unique ordered list of Meetup dates

```{r}
Meetup_dates <- sort(unique(member_list$Last.Attended))
```

How many new member since last meetup?

```{r}
new_members <- subset(member_list, Joined.Group.on > Meetup_dates[NROW(Meetup_dates)])

NROW(new_members)
```
 
How about the number of new members between last meetup and the one prior to that?

```{r}
new_members2 <- subset(member_list, Joined.Group.on <= Meetup_dates[NROW(Meetup_dates)] &
                                    Joined.Group.on > Meetup_dates[NROW(Meetup_dates)-1])
  # how many?
NROW(new_members2)
```

  
How about iterating over this process over all CRUG meetups?


```{r, warning=FALSE}
 ## First, get a unique ordered list of Meetup dates
  Meetup_dates <- c(sort(unique(member_list$Last.Attended)), Sys.Date())

  # initialize data.frame to save memory
  new_df <- data.frame("Date"=NULL, "count_index"=NULL)
  
  # start the for loop
  for(i in 1:NROW(Meetup_dates)-1) {
          
   df <- subset(member_list, Joined.Group.on <= Meetup_dates[NROW(Meetup_dates)-(i-1)] &
                             Joined.Group.on > Meetup_dates[NROW(Meetup_dates)-(i)])
        
        Date <- Meetup_dates[NROW(Meetup_dates)-(i-1)]
        New  <- max(df$count_index) - min(df$count_index)
        
        new_df <- rbind(new_df,data.frame(Date, New))
        
        
        }
```

That works, so lets turn it into a function for future use.


```{r}
 
 new_mem_counter <- function(data) {
         
         Meetup_dates <- c(sort(unique(data$Last.Attended)), Sys.Date()-1)
         
         data <- data[,c("Joined.Group.on", "count_index")]
         
         #initialize data.frame
         new_df <- data.frame("Date"=Meetup_dates[1], "New"=0)
         
         for(i in (NROW(Meetup_dates)-1):1) {
                 
                 df <- subset(data, data$Joined.Group.on <= Meetup_dates[NROW(Meetup_dates)-(i-1)] &
                                      data$Joined.Group.on > Meetup_dates[NROW(Meetup_dates)-(i)])
                 
                 Date <- Meetup_dates[NROW(Meetup_dates)-(i-1)]
                 New  <- max(df$count_index) - min(df$count_index)
                 
                 new_df <- rbind(new_df,data.frame(Date, New))
                 
                 
         }
         
       return(new_df) 
}
 
 new_members <- new_mem_counter(member_list)
 
 new_members
```

Lets Explore the `new_members` data set.
Which gap between meetups had the most new members?
 
```{r}
 kable(new_members[new_members$New==max(new_members$New),])
```

Let plot the `new members` data.

```{r}
   # Create Date Range Index
  Start_Date <- "2010-01-01"
    End_Date <- Sys.Date()
  Date_Index <- as.numeric(row.names(new_members[new_members$Date > Start_Date &
                                                new_members$Date <= End_Date,]))
  
  # Create x-axis labels, using year-month date format
  x_labels <- format(new_members$Date[Date_Index], "%Y-%m")

  # Plot
  barplot(new_members$New[Date_Index], names.arg = x_labels,
         main = "CRUG members, joined between meetups",  
         ylab = "New Members", xlab = "")
```

Let plot the `new members` data since 2017.

```{r}
   # Create Date Range Index
  Start_Date <- "2017-01-01"
    End_Date <- Sys.Date()
  Date_Index <- as.numeric(row.names(new_members[new_members$Date > Start_Date &
                                                new_members$Date <= End_Date,]))
  
  # Create x-axis labels, using year-month date format
  x_labels <- format(new_members$Date[Date_Index], "%Y-%m")

  # Plot
  barplot(new_members$New[Date_Index], names.arg = x_labels, las=2,
         main = "CRUG members, joined between meetups",  
         ylab = "New Members", xlab = "")
```
 